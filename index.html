<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCP Pub/Sub Chat</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        #chat-box { height: 400px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 5px; }
        .username { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>Real-time Chat with GCP Pub/Sub</h1>
    <div id="chat-box"></div>
    <form id="message-form">
        <input type="text" id="username" placeholder="Your Name" required>
        <input type="text" id="message-input" placeholder="Type a message..." required>
        <button type="submit">Send</button>
    </form>

    <script>
    const chatBox = document.getElementById('chat-box');
    const messageForm = document.getElementById('message-form');
    const usernameInput = document.getElementById('username');
    const messageInput = document.getElementById('message-input');

    // Function to add a message to the chat box
    function addMessage(data) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.innerHTML = `<span class="username">${data.username}:</span> ${data.message}`;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Set up Server-Sent Events (SSE) to receive new messages
    const eventSource = new EventSource('/stream');
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        addMessage(data);
    };

    // Handle form submission
    messageForm.addEventListener('submit', async function(e) {
        // THIS IS THE CRUCIAL LINE
        e.preventDefault();

        const username = usernameInput.value;
        const message = messageInput.value;
        if (username && message) {
            try {
                await fetch('/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, message })
                });
                messageInput.value = ''; // Clear the input field
            } catch (error) {
                console.error('Error publishing message:', error);
            }
        }
    });
</script>
</body>
</html>